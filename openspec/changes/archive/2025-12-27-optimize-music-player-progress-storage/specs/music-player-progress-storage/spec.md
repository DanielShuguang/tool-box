## 新增需求

### 需求：单音乐进度存储

系统必须仅存储当前正在播放的单个音乐进度，不再存储多个音乐的进度。

#### 场景：保存当前播放音乐进度

- **当** 用户正在播放音乐
- **并且** 音乐播放到 30 秒位置
- **那么** 系统必须保存当前音乐的 ID 为 "track-123"
- **并且** 系统必须保存当前播放时间为 30 秒
- **并且** 系统必须保存播放状态为 true（正在播放）

#### 场景：切换音乐时更新进度

- **当** 用户从音乐 A 切换到音乐 B
- **那么** 系统必须更新当前音乐的 ID 为音乐 B 的 ID
- **并且** 系统必须重置当前播放时间为 0
- **并且** 系统必须保存播放状态为 true（正在播放）

#### 场景：暂停时更新播放状态

- **当** 用户暂停正在播放的音乐
- **那么** 系统必须保持当前音乐的 ID 不变
- **并且** 系统必须保持当前播放时间不变
- **并且** 系统必须更新播放状态为 false（已暂停）

#### 场景：停止时清空进度

- **当** 用户停止播放音乐
- **那么** 系统必须清空当前音乐的 ID（设置为 null）
- **并且** 系统必须重置当前播放时间为 0
- **并且** 系统必须更新播放状态为 false（已停止）

#### 场景：获取当前播放进度

- **当** 系统需要获取当前播放进度
- **那么** 系统必须返回当前音乐的 ID
- **并且** 系统必须返回当前播放时间
- **并且** 系统必须返回播放状态

#### 场景：持久化存储配置

- **当** 系统配置持久化存储
- **那么** 系统必须仅持久化 `currentTrackId`、`currentTime`、`isPlaying` 三个字段
- **并且** 系统必须使用 `ConfigFile.MusicPlayer` 作为存储文件名
- **并且** 系统必须使用 `playback-progress` 作为存储键

### 需求：音轨预加载机制

系统必须在初始化加载音乐进度时预加载目标音乐音轨，确保用户能够无缝继续播放。

#### 场景：预加载音乐音轨

- **当** 系统需要预加载音乐音轨
- **并且** 提供音乐文件路径为 "/music/track.mp3"
- **那么** 系统必须通过后端读取音频文件数据
- **并且** 系统必须根据文件扩展名确定 MIME 类型
- **并且** 系统必须创建 Blob 对象
- **并且** 系统必须创建 Blob URL
- **并且** 系统必须设置 Audio 元素的 src 属性
- **并且** 系统必须调用 Audio.load() 方法加载音轨

#### 场景：预加载成功

- **当** 系统成功预加载音乐音轨
- **那么** 系统必须保存预加载的音乐信息到 `preloadedTrack` 状态
- **并且** 系统必须更新 `currentTrackPath` 为预加载音乐的路径
- **并且** 系统必须释放旧的 Blob URL（如果存在）

#### 场景：预加载失败

- **当** 系统预加载音乐音轨失败
- **那么** 系统必须在控制台输出错误信息
- **并且** 系统必须将 `currentBlobUrl` 设置为 null
- **并且** 系统必须将 `preloadedTrack` 设置为 null

#### 场景：检查是否可以使用预加载音轨

- **当** 系统检查是否可以使用预加载音轨
- **并且** 预加载的音乐 ID 与目标音乐 ID 相同
- **那么** 系统必须返回 true（可以使用预加载音轨）

#### 场景：检查无法使用预加载音轨

- **当** 系统检查是否可以使用预加载音轨
- **并且** 预加载的音乐 ID 与目标音乐 ID 不同
- **那么** 系统必须返回 false（无法使用预加载音轨）

#### 场景：释放预加载资源

- **当** 系统需要释放预加载资源
- **并且** 存在旧的 Blob URL
- **那么** 系统必须调用 URL.revokeObjectURL() 释放 Blob URL
- **并且** 系统必须将 `currentBlobUrl` 设置为 null

### 需求：初始化加载音乐进度

系统必须在应用启动时检查并加载保存的播放进度，并预加载对应的音乐音轨。

#### 场景：有保存的播放进度

- **当** 应用启动
- **并且** 存在保存的播放进度
- **并且** 保存的音乐 ID 为 "track-123"
- **并且** 保存的播放时间为 45 秒
- **并且** 保存的播放状态为 true
- **那么** 系统必须在播放列表中查找 ID 为 "track-123" 的音乐
- **并且** 系统必须预加载该音乐音轨
- **并且** 系统必须设置播放时间为 45 秒
- **并且** 系统必须更新当前音乐 ID 为 "track-123"

#### 场景：保存的音乐不存在于播放列表

- **当** 应用启动
- **并且** 存在保存的播放进度
- **并且** 保存的音乐 ID 为 "track-123"
- **并且** 播放列表中不存在 ID 为 "track-123" 的音乐
- **那么** 系统必须清空保存的播放进度
- **并且** 系统必须不进行预加载

#### 场景：没有保存的播放进度

- **当** 应用启动
- **并且** 不存在保存的播放进度
- **那么** 系统必须不进行预加载
- **并且** 系统必须保持初始状态

#### 场景：保存的播放时间为 0

- **当** 应用启动
- **并且** 存在保存的播放进度
- **并且** 保存的播放时间为 0
- **那么** 系统必须不进行预加载
- **并且** 系统必须保持初始状态

#### 场景：初始化加载不阻塞界面

- **当** 系统进行初始化加载
- **那么** 系统必须在后台异步执行预加载
- **并且** 系统必须不阻塞用户界面
- **并且** 系统必须提供加载状态提示

### 需求：播放器协调器更新

系统必须更新播放器协调器逻辑，支持预加载音轨和单音乐进度存储。

#### 场景：播放已预加载的音乐

- **当** 用户点击播放按钮
- **并且** 目标音乐已预加载
- **那么** 系统必须直接使用预加载的音轨
- **并且** 系统必须立即开始播放
- **并且** 系统必须不重新加载音轨

#### 场景：播放未预加载的音乐

- **当** 用户点击播放按钮
- **并且** 目标音乐未预加载
- **那么** 系统必须加载新音轨
- **并且** 系统必须等待音轨加载完成后开始播放

#### 场景：切换音乐时更新进度

- **当** 用户切换到新音乐
- **那么** 系统必须更新 `playbackProgressStore` 的 `currentTrackId` 为新音乐的 ID
- **并且** 系统必须更新 `currentTime` 为 0
- **并且** 系统必须更新 `isPlaying` 为 true

#### 场景：暂停时更新进度状态

- **当** 用户暂停播放
- **那么** 系统必须保持 `currentTrackId` 不变
- **并且** 系统必须保持 `currentTime` 不变
- **并且** 系统必须更新 `isPlaying` 为 false

### 需求：数据迁移

系统必须支持从旧版本的多音乐进度存储迁移到新的单音乐进度存储。

#### 场景：检测旧版本数据格式

- **当** 应用启动
- **并且** 存储的数据格式为 `Record<string, number>`
- **那么** 系统必须识别为旧版本数据
- **并且** 系统必须触发数据迁移

#### 场景：迁移时保留当前播放音乐进度

- **当** 系统进行数据迁移
- **并且** 旧版本数据中存在多个音乐的进度
- **并且** 当前播放的音乐 ID 为 "track-123"
- **并且** 该音乐的进度为 30 秒
- **那么** 系统必须保留音乐 "track-123" 的进度
- **并且** 系统必须忽略其他音乐的进度
- **并且** 系统必须将进度保存到新的存储结构

#### 场景：迁移时没有当前播放音乐

- **当** 系统进行数据迁移
- **并且** 旧版本数据中存在多个音乐的进度
- **并且** 没有当前播放的音乐
- **那么** 系统必须清空所有进度
- **并且** 系统必须使用新的存储结构初始化

#### 场景：迁移完成后更新存储格式

- **当** 系统完成数据迁移
- **那么** 系统必须删除旧版本数据
- **并且** 系统必须使用新的存储结构保存数据

### 需求：Hook 简化

系统必须简化播放进度 Hook 的实现，移除不必要的参数。

#### 场景：获取当前播放进度

- **当** 组件调用 `usePlaybackProgress` Hook
- **那么** 系统必须返回 `currentTrackId`、`currentTime`、`isPlaying` 三个响应式引用
- **并且** 系统必须返回 `saveProgress`、`getProgress`、`pauseProgress`、`clearProgress` 方法
- **并且** 系统必须返回 `setCurrentTrack` 方法

#### 场景：设置当前音乐

- **当** 组件调用 `setCurrentTrack(trackId)` 方法
- **并且** 传入的音乐 ID 与当前音乐 ID 不同
- **那么** 系统必须更新 `currentTrackId` 为新的音乐 ID
- **并且** 系统必须重置 `currentTime` 为 0

#### 场景：设置当前音乐为相同音乐

- **当** 组件调用 `setCurrentTrack(trackId)` 方法
- **并且** 传入的音乐 ID 与当前音乐 ID 相同
- **那么** 系统必须保持 `currentTime` 不变

#### 场景：保存播放进度

- **当** 组件调用 `saveProgress(trackId, time)` 方法
- **那么** 系统必须更新 `currentTrackId` 为传入的 trackId
- **并且** 系统必须更新 `currentTime` 为传入的 time
- **并且** 系统必须更新 `isPlaying` 为 true

### 需求：组件初始化更新

系统必须更新音乐播放器组件的初始化逻辑，调用进度初始化方法。

#### 场景：组件挂载时初始化进度

- **当** 音乐播放器组件挂载
- **那么** 系统必须调用 `initializeProgress` 方法
- **并且** 系统必须等待初始化完成

#### 场景：初始化时显示加载状态

- **当** 系统进行初始化加载
- **那么** 系统必须显示加载提示
- **并且** 系统必须在初始化完成后隐藏加载提示

#### 场景：初始化失败时显示错误

- **当** 系统初始化失败
- **那么** 系统必须显示错误提示
- **并且** 系统必须记录错误日志
