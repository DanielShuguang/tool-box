## 新增需求

### 需求：歌词显示

系统必须在播放音乐时显示歌词，并提供歌词与播放进度的同步功能。

#### 场景：自动获取并显示歌词

- **当** 用户播放一首新歌曲
- **并且** 系统检测到本地无歌词缓存
- **那么** 系统必须调用QQ音乐歌词API搜索歌词
- **并且** 系统必须解析获取到的歌词文本（LRC/QRC/KSC格式）
- **并且** 系统必须在播放器页面显示歌词
- **并且** 系统必须将歌词缓存到本地目录

#### 场景：从缓存加载歌词

- **当** 用户播放一首已缓存歌词的歌曲
- **那么** 系统必须从本地缓存加载歌词
- **并且** 系统必须在播放器页面显示歌词
- **并且** 系统必须更新歌词的访问时间（用于LRU淘汰）

#### 场景：歌词同步

- **当** 音频播放进度发生变化
- **那么** 系统必须根据当前播放时间高亮对应的歌词行
- **并且** 系统必须自动滚动歌词列表，使当前行位于可视区域中心
- **并且** 同步精度必须达到100毫秒

#### 场景：歌词显示/隐藏切换

- **当** 用户点击歌词切换按钮
- **那么** 系统必须在显示/隐藏歌词之间切换
- **并且** 系统必须保存歌词显示状态
- **并且** 下次打开播放器时恢复上次显示状态

#### 场景：无歌词时提示

- **当** 系统无法获取歌词（API失败或无匹配结果）
- **那么** 系统必须在歌词区域显示"暂无歌词"提示
- **并且** 系统必须提供手动上传歌词的入口

### 需求：歌词缓存管理

系统必须提供歌词缓存功能，支持手动清理和自动清理（LRU淘汰）。

#### 场景：歌词缓存存储

- **当** 系统成功获取歌词
- **那么** 系统必须将歌词数据保存为JSON文件
- **并且** 缓存文件命名格式必须为 `{trackId}.json`
- **并且** 缓存文件必须包含歌曲元数据（歌名、歌手、来源等）
- **并且** 系统必须记录缓存的创建时间和访问时间

#### 场景：缓存目录设置

- **当** 用户首次使用歌词功能
- **那么** 系统必须在应用数据目录创建默认歌词缓存目录
- **并且** 默认路径必须为 `{AppData}/lyrics-cache/`
- **并且** 系统必须在设置中显示当前缓存路径

#### 场景：修改缓存路径

- **当** 用户在设置中修改歌词缓存路径
- **那么** 系统必须验证新路径的读写权限
- **并且** 系统必须将现有缓存文件迁移到新路径
- **并且** 系统必须保存新路径配置
- **并且** 如果迁移失败，系统必须回滚到原路径并提示用户

#### 场景：缓存容量设置

- **当** 用户在设置中修改歌词缓存容量
- **那么** 系统必须保存新容量配置
- **并且** 系统必须在设置中显示当前缓存大小和容量上限
- **并且** 默认缓存容量必须为100MB

#### 场景：LRU自动清理

- **当** 缓存目录大小超过设定的最大容量
- **那么** 系统必须按照LRU（最近最少使用）策略删除歌词缓存
- **并且** 系统必须优先删除最久未被访问的缓存文件
- **并且** 系统必须持续删除直到缓存大小低于容量上限
- **并且** 系统必须记录清理操作的日志

#### 场景：手动清理缓存

- **当** 用户在设置中点击"清理歌词缓存"按钮
- **那么** 系统必须显示确认对话框，说明将要删除所有缓存
- **并且** 用户确认后，系统必须删除所有歌词缓存文件
- **并且** 系统必须重置缓存统计信息
- **并且** 清理完成后，系统必须显示清理结果（删除文件数量）

### 需求：歌词编辑和上传

系统必须支持用户手动编辑歌词和上传本地歌词文件。

#### 场景：手动编辑歌词

- **当** 用户点击歌词编辑按钮
- **那么** 系统必须显示歌词编辑对话框
- **并且** 编辑框中必须显示当前歌词内容
- **并且** 用户可以修改歌词文本（时间标签和歌词内容）
- **并且** 用户保存后，系统必须更新本地缓存
- **并且** 系统必须重新解析并显示更新后的歌词

#### 场景：上传歌词文件

- **当** 用户点击"上传歌词文件"按钮
- **那么** 系统必须打开文件选择对话框
- **并且** 系统必须只显示支持的文件格式（LRC、QRC、KSC）
- **并且** 用户选择文件后，系统必须解析文件内容
- **并且** 系统必须将解析后的歌词保存到缓存
- **并且** 系统必须刷新显示新上传的歌词
- **并且** 如果解析失败，系统必须提示用户文件格式错误

#### 场景：歌词格式识别

- **当** 系统解析上传的歌词文件
- **那么** 系统必须自动识别文件格式（LRC/QRC/KSC）
- **并且** 系统必须根据格式选择对应的解析器
- **并且** 如果无法识别格式，系统必须提示用户

### 需求：歌词搜索

系统必须支持通过关键词搜索歌词。

#### 场景：按歌曲ID搜索歌词

- **当** 用户播放的歌曲包含有效的歌曲ID
- **那么** 系统必须优先使用歌曲ID调用API获取歌词
- **并且** 如果API返回结果，系统必须直接使用该歌词
- **并且** 如果API无结果，系统可以尝试使用歌曲信息搜索

#### 场景：按关键词搜索歌词

- **当** 系统无法通过歌曲ID获取歌词
- **那么** 系统必须使用歌曲名称和艺术家作为关键词搜索
- **并且** 系统必须在设置中提供API搜索结果的候选列表
- **并且** 用户选择后，系统必须将选中歌词保存到缓存

### 需求：歌词设置

系统必须在应用设置中提供歌词相关配置选项。

#### 场景：歌词设置显示

- **当** 用户打开应用设置页面
- **那么** 系统必须在设置中显示"歌词设置"分类
- **并且** 该分类必须包含以下配置项：
  - 缓存路径（可修改）
  - 缓存容量（可修改）
  - 当前缓存大小（只读显示）
  - 清理缓存按钮

#### 场景：缓存信息显示

- **当** 用户查看歌词设置
- **那么** 系统必须显示以下信息：
  - 当前缓存路径
  - 当前缓存大小（格式：XX MB）
  - 缓存文件数量
  - 缓存容量上限

## 非功能需求

### 性能需求

- **响应时间**：歌词API请求超时时间不得超过5秒
- **同步精度**：歌词高亮同步精度必须达到100毫秒
- **缓存性能**：歌词加载和保存操作必须在500毫秒内完成
- **内存占用**：歌词解析后的内存占用不得超过歌曲数量的线性增长

### 可用性需求

- **离线支持**：已缓存的歌词必须在无网络时正常显示
- **错误恢复**：API请求失败时，必须显示友好的错误提示
- **操作反馈**：所有歌词操作（保存、上传、清理）必须提供操作反馈
- **状态保存**：歌词显示状态、编辑内容必须在页面刷新时恢复

### 安全需求

- **文件路径验证**：缓存路径必须经过验证，防止路径遍历攻击
- **文件大小限制**：单个歌词文件不得超过1MB
- **格式验证**：上传的歌词文件必须经过格式验证
- **权限检查**：写入缓存目录前必须检查目录权限

### 扩展性需求

- **格式扩展**：歌词解析器必须支持插件式扩展新格式
- **桌面歌词预留**：歌词显示组件必须支持替换为桌面歌词渲染器
- **多源支持**：歌词获取模块必须支持配置多个歌词源（当前仅QQ音乐）
